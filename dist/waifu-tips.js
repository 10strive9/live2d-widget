/*!
 * Live2D Widget
 * https://github.com/stevenjoezhang/live2d-widget
 */
!function(){"use strict";var t,e=this&&this.__spreadArray||function(t,e,i){if(i||2===arguments.length)for(var n,o=0,r=e.length;o<r;o++)!n&&o in e||(n||(n=Array.prototype.slice.call(e,0,o)),n[o]=e[o]);return t.concat(n||Array.prototype.slice.call(e))},i=function(){function t(t){void 0===t&&(t="info"),this.level=t}return t.prototype.setLevel=function(t){t&&(this.level=t)},t.prototype.shouldLog=function(e){return t.levelOrder[e]<=t.levelOrder[this.level]},t.prototype.error=function(t){for(var i=[],n=1;n<arguments.length;n++)i[n-1]=arguments[n];this.shouldLog("error")&&console.error.apply(console,e(["[Live2d Widget][ERROR]",t],i,!1))},t.prototype.warn=function(t){for(var i=[],n=1;n<arguments.length;n++)i[n-1]=arguments[n];this.shouldLog("warn")&&console.warn.apply(console,e(["[Live2d Widget][WARN ]",t],i,!1))},t.prototype.info=function(t){for(var i=[],n=1;n<arguments.length;n++)i[n-1]=arguments[n];this.shouldLog("info")&&console.log.apply(console,e(["[Live2d Widget][INFO ]",t],i,!1))},t.prototype.trace=function(t){for(var i=[],n=1;n<arguments.length;n++)i[n-1]=arguments[n];this.shouldLog("trace")&&console.log.apply(console,e(["[Live2d Widget][TRACE]",t],i,!1))},t.levelOrder={error:0,warn:1,info:2,trace:3},t}(),n=new i,o=this&&this.__extends||(t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},t(e,i)},function(e,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}),r=function(){function t(){this.live2DModel=null,this.modelMatrix=null,this.eyeBlink=null,this.physics=null,this.pose=null,this.initialized=!1,this.updating=!1,this.alpha=1,this.accAlpha=0,this.lipSync=!1,this.lipSyncValue=0,this.accelX=0,this.accelY=0,this.accelZ=0,this.dragX=0,this.dragY=0,this.startTimeMSec=null,this.mainMotionManager=new p,this.expressionManager=new p,this.motions={},this.expressions={},this.isTexLoaded=!1}return t.prototype.getModelMatrix=function(){return this.modelMatrix},t.prototype.setAlpha=function(t){t>.999&&(t=1),t<.001&&(t=0),this.alpha=t},t.prototype.getAlpha=function(){return this.alpha},t.prototype.isInitialized=function(){return this.initialized},t.prototype.setInitialized=function(t){this.initialized=t},t.prototype.isUpdating=function(){return this.updating},t.prototype.setUpdating=function(t){this.updating=t},t.prototype.getLive2DModel=function(){return this.live2DModel},t.prototype.setLipSync=function(t){this.lipSync=t},t.prototype.setLipSyncValue=function(t){this.lipSyncValue=t},t.prototype.setAccel=function(t,e,i){this.accelX=t,this.accelY=e,this.accelZ=i},t.prototype.setDrag=function(t,e){this.dragX=t,this.dragY=e},t.prototype.getMainMotionManager=function(){return this.mainMotionManager},t.prototype.getExpressionManager=function(){return this.expressionManager},t.prototype.loadModelData=function(t,e){var i=this,o=M.getPlatformManager();n.info("Load model : "+t),o.loadLive2DModel(t,(function(t){i.live2DModel=t,i.live2DModel.saveParam(),0==Live2D.getError()?(i.modelMatrix=new d(i.live2DModel.getCanvasWidth(),i.live2DModel.getCanvasHeight()),i.modelMatrix.setWidth(2),i.modelMatrix.setCenterPosition(0,0),e(i.live2DModel)):n.error("Error : Failed to loadModelData().")}))},t.prototype.loadTexture=function(t,e,i){var o=this;s++;var r=M.getPlatformManager();n.info("Load Texture : "+e),r.loadTexture(this.live2DModel,t,e,(function(){0==--s&&(o.isTexLoaded=!0),"function"==typeof i&&i()}))},t.prototype.loadMotion=function(t,e,i){var o=this,r=M.getPlatformManager();n.trace("Load Motion : "+e);var s=null;r.loadBytes(e,(function(e){s=Live2DMotion.loadMotion(e),null!=t&&(o.motions[t]=s),i(s)}))},t.prototype.loadExpression=function(t,e,i){var o=this,r=M.getPlatformManager();n.trace("Load Expression : "+e),r.loadBytes(e,(function(e){null!=t&&(o.expressions[t]=a.loadJson(e)),"function"==typeof i&&i()}))},t.prototype.loadPose=function(t,e){var i=this,o=M.getPlatformManager();n.trace("Load Pose : "+t);try{o.loadBytes(t,(function(t){i.pose=m.load(t),"function"==typeof e&&e()}))}catch(t){n.warn(t)}},t.prototype.loadPhysics=function(t){var e=this,i=M.getPlatformManager();n.trace("Load Physics : "+t);try{i.loadBytes(t,(function(t){e.physics=f.load(t)}))}catch(t){n.warn(t)}},t.prototype.hitTestSimple=function(t,e,i){var n=this.live2DModel.getDrawDataIndex(t);if(n<0)return!1;for(var o=this.live2DModel.getTransformedPoints(n),r=this.live2DModel.getCanvasWidth(),s=0,a=this.live2DModel.getCanvasHeight(),l=0,c=0;c<o.length;c+=2){var h=o[c],u=o[c+1];h<r&&(r=h),h>s&&(s=h),u<a&&(a=u),u>l&&(l=u)}var d=this.modelMatrix.invertTransformX(e),p=this.modelMatrix.invertTransformY(i);return r<=d&&d<=s&&a<=p&&p<=l},t}(),s=0,a=function(t){function e(){var e=t.call(this)||this;return e.paramList=[],e}return o(e,t),e.loadJson=function(t){var i=new e,n=M.getPlatformManager().jsonParseFromBytes(t);if(i.setFadeIn(parseInt(n.fade_in)>0?parseInt(n.fade_in):1e3),i.setFadeOut(parseInt(n.fade_out)>0?parseInt(n.fade_out):1e3),null==n.params)return i;var o=n.params,r=o.length;i.paramList=[];for(var s=0;s<r;s++){var a=o[s],c=a.id.toString(),h=parseFloat(a.val),u=e.TYPE_ADD,d=null!=a.calc?a.calc.toString():"add";if((u="add"===d?e.TYPE_ADD:"mult"===d?e.TYPE_MULT:"set"===d?e.TYPE_SET:e.TYPE_ADD)==e.TYPE_ADD)h-=p=null==a.def?0:parseFloat(a.def);else if(u==e.TYPE_MULT){var p;0==(p=null==a.def?1:parseFloat(a.def))&&(p=1),h/=p}var f=new l;f.id=c,f.type=u,f.value=h,i.paramList.push(f)}return i},e.prototype.updateParamExe=function(t,i,n,o){for(var r=this.paramList.length-1;r>=0;--r){var s=this.paramList[r];s.type==e.TYPE_ADD?t.addToParamFloat(s.id,s.value,n):s.type==e.TYPE_MULT?t.multParamFloat(s.id,s.value,n):s.type==e.TYPE_SET&&t.setParamFloat(s.id,s.value,n)}},e}(AMotion);function l(){this.id="",this.type=-1,this.value=null}a.EXPRESSION_DEFAULT="DEFAULT",a.TYPE_SET=0,a.TYPE_ADD=1,a.TYPE_MULT=2;var c=function(){function t(){this.nextBlinkTime=null,this.stateStartTime=null,this.blinkIntervalMsec=null,this.eyeState=h.STATE_FIRST,this.blinkIntervalMsec=4e3,this.closingMotionMsec=100,this.closedMotionMsec=50,this.openingMotionMsec=150,this.closeIfZero=!0,this.eyeID_L="PARAM_EYE_L_OPEN",this.eyeID_R="PARAM_EYE_R_OPEN"}return t.prototype.calcNextBlink=function(){return UtSystem.getUserTimeMSec()+Math.random()*(2*this.blinkIntervalMsec-1)},t.prototype.setInterval=function(t){this.blinkIntervalMsec=t},t.prototype.setEyeMotion=function(t,e,i){this.closingMotionMsec=t,this.closedMotionMsec=e,this.openingMotionMsec=i},t.prototype.updateParam=function(t){var e,i=UtSystem.getUserTimeMSec(),n=0;switch(this.eyeState){case h.STATE_CLOSING:(n=(i-this.stateStartTime)/this.closingMotionMsec)>=1&&(n=1,this.eyeState=h.STATE_CLOSED,this.stateStartTime=i),e=1-n;break;case h.STATE_CLOSED:(n=(i-this.stateStartTime)/this.closedMotionMsec)>=1&&(this.eyeState=h.STATE_OPENING,this.stateStartTime=i),e=0;break;case h.STATE_OPENING:(n=(i-this.stateStartTime)/this.openingMotionMsec)>=1&&(n=1,this.eyeState=h.STATE_INTERVAL,this.nextBlinkTime=this.calcNextBlink()),e=n;break;case h.STATE_INTERVAL:this.nextBlinkTime<i&&(this.eyeState=h.STATE_CLOSING,this.stateStartTime=i),e=1;break;case h.STATE_FIRST:default:this.eyeState=h.STATE_INTERVAL,this.nextBlinkTime=this.calcNextBlink(),e=1}this.closeIfZero||(e=-e),t.setParamFloat(this.eyeID_L,e),t.setParamFloat(this.eyeID_R,e)},t}(),h=function(){};h.STATE_FIRST="STATE_FIRST",h.STATE_INTERVAL="STATE_INTERVAL",h.STATE_CLOSING="STATE_CLOSING",h.STATE_CLOSED="STATE_CLOSED",h.STATE_OPENING="STATE_OPENING";var u=function(){function t(){this.tr=new Float32Array(16),this.identity()}return t.mul=function(t,e,i){var n,o,r,s=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(n=0;n<4;n++)for(o=0;o<4;o++)for(r=0;r<4;r++)s[n+4*o]+=t[n+4*r]*e[r+4*o];for(n=0;n<16;n++)i[n]=s[n]},t.prototype.identity=function(){for(var t=0;t<16;t++)this.tr[t]=t%5==0?1:0},t.prototype.getArray=function(){return this.tr},t.prototype.getCopyMatrix=function(){return new Float32Array(this.tr)},t.prototype.setMatrix=function(t){if(null!=this.tr&&this.tr.length==this.tr.length)for(var e=0;e<16;e++)this.tr[e]=t[e]},t.prototype.getScaleX=function(){return this.tr[0]},t.prototype.getScaleY=function(){return this.tr[5]},t.prototype.transformX=function(t){return this.tr[0]*t+this.tr[12]},t.prototype.transformY=function(t){return this.tr[5]*t+this.tr[13]},t.prototype.invertTransformX=function(t){return(t-this.tr[12])/this.tr[0]},t.prototype.invertTransformY=function(t){return(t-this.tr[13])/this.tr[5]},t.prototype.multTranslate=function(e,i){var n=[1,0,0,0,0,1,0,0,0,0,1,0,e,i,0,1];t.mul(n,this.tr,this.tr)},t.prototype.translate=function(t,e){this.tr[12]=t,this.tr[13]=e},t.prototype.translateX=function(t){this.tr[12]=t},t.prototype.translateY=function(t){this.tr[13]=t},t.prototype.multScale=function(e,i){var n=[e,0,0,0,0,i,0,0,0,0,1,0,0,0,0,1];t.mul(n,this.tr,this.tr)},t.prototype.scale=function(t,e){this.tr[0]=t,this.tr[5]=e},t}(),d=function(t){function e(e,i){var n=t.call(this)||this;return n.width=e,n.height=i,n}return o(e,t),e.prototype.setPosition=function(t,e){this.translate(t,e)},e.prototype.setCenterPosition=function(t,e){var i=this.width*this.getScaleX(),n=this.height*this.getScaleY();this.translate(t-i/2,e-n/2)},e.prototype.top=function(t){this.setY(t)},e.prototype.bottom=function(t){var e=this.height*this.getScaleY();this.translateY(t-e)},e.prototype.left=function(t){this.setX(t)},e.prototype.right=function(t){var e=this.width*this.getScaleX();this.translateX(t-e)},e.prototype.centerX=function(t){var e=this.width*this.getScaleX();this.translateX(t-e/2)},e.prototype.centerY=function(t){var e=this.height*this.getScaleY();this.translateY(t-e/2)},e.prototype.setX=function(t){this.translateX(t)},e.prototype.setY=function(t){this.translateY(t)},e.prototype.setHeight=function(t){var e=t/this.height,i=-e;this.scale(e,i)},e.prototype.setWidth=function(t){var e=t/this.width,i=-e;this.scale(e,i)},e}(u),p=function(t){function e(){var e=t.call(this)||this;return e.currentPriority=null,e.reservePriority=null,e.super=MotionQueueManager.prototype,e}return o(e,t),e.prototype.getCurrentPriority=function(){return this.currentPriority},e.prototype.getReservePriority=function(){return this.reservePriority},e.prototype.reserveMotion=function(t){return!(this.reservePriority>=t)&&(!(this.currentPriority>=t)&&(this.reservePriority=t,!0))},e.prototype.setReservePriority=function(t){this.reservePriority=t},e.prototype.updateParam=function(t){var e=MotionQueueManager.prototype.updateParam.call(this,t);return this.isFinished()&&(this.currentPriority=0),e},e.prototype.startMotionPrio=function(t,e){return e==this.reservePriority&&(this.reservePriority=0),this.currentPriority=e,this.startMotion(t,!1)},e}(MotionQueueManager),f=function(){function t(){this.physicsList=[],this.startTimeMSec=UtSystem.getUserTimeMSec()}return t.load=function(e){for(var i=new t,n=M.getPlatformManager().jsonParseFromBytes(e).physics_hair,o=n.length,r=0;r<o;r++){var s=n[r],a=new PhysicsHair,l=s.setup,c=parseFloat(l.length),h=parseFloat(l.regist),u=parseFloat(l.mass);a.setup(c,h,u);for(var d=s.src,p=d.length,f=0;f<p;f++){var m=d[f],g=m.id,v=PhysicsHair.Src.SRC_TO_X;"x"===(I=m.ptype)?v=PhysicsHair.Src.SRC_TO_X:"y"===I?v=PhysicsHair.Src.SRC_TO_Y:"angle"===I?v=PhysicsHair.Src.SRC_TO_G_ANGLE:UtDebug.error("live2d","Invalid parameter:PhysicsHair.Src");var y=parseFloat(m.scale),S=parseFloat(m.weight);a.addSrcParam(v,g,y,S)}var T=s.targets,w=T.length;for(f=0;f<w;f++){var I,x=T[f];g=x.id,v=PhysicsHair.Target.TARGET_FROM_ANGLE;"angle"===(I=x.ptype)?v=PhysicsHair.Target.TARGET_FROM_ANGLE:"angle_v"===I?v=PhysicsHair.Target.TARGET_FROM_ANGLE_V:UtDebug.error("live2d","Invalid parameter:PhysicsHair.Target");y=parseFloat(x.scale),S=parseFloat(x.weight);a.addTargetParam(v,g,y,S)}i.physicsList.push(a)}return i},t.prototype.updateParam=function(t){for(var e=UtSystem.getUserTimeMSec()-this.startTimeMSec,i=0;i<this.physicsList.length;i++)this.physicsList[i].update(t,e)},t}(),m=function(){function t(){this.lastTime=0,this.lastModel=null,this.partsGroups=[]}return t.load=function(e){for(var i=new t,n=M.getPlatformManager().jsonParseFromBytes(e).parts_visible,o=n.length,r=0;r<o;r++){for(var s=n[r].group,a=s.length,l=[],c=0;c<a;c++){var h=s[c],u=new g(h.id);if(l[c]=u,null!=h.link){var d=h.link,p=d.length;u.link=[];for(var f=0;f<p;f++){var m=new g(d[f]);u.link.push(m)}}}i.partsGroups.push(l)}return i},t.prototype.updateParam=function(t){if(null!=t){t!=this.lastModel&&this.initParam(t),this.lastModel=t;var e=UtSystem.getUserTimeMSec(),i=0==this.lastTime?0:(e-this.lastTime)/1e3;this.lastTime=e,i<0&&(i=0);for(var n=0;n<this.partsGroups.length;n++)this.normalizePartsOpacityGroup(t,this.partsGroups[n],i),this.copyOpacityOtherParts(t,this.partsGroups[n])}},t.prototype.initParam=function(t){if(null!=t)for(var e=0;e<this.partsGroups.length;e++)for(var i=this.partsGroups[e],n=0;n<i.length;n++){i[n].initIndex(t);var o=i[n].partsIndex,r=i[n].paramIndex;if(!(o<0)){var s=0!=t.getParamFloat(r);if(t.setPartsOpacity(o,s?1:0),t.setParamFloat(r,s?1:0),null!=i[n].link)for(var a=0;a<i[n].link.length;a++)i[n].link[a].initIndex(t)}}},t.prototype.normalizePartsOpacityGroup=function(t,e,i){for(var n=-1,o=1,r=.5,s=0;s<e.length;s++){var a=e[s].partsIndex,l=e[s].paramIndex;if(!(a<0)&&0!=t.getParamFloat(l)){if(n>=0)break;n=s,o=t.getPartsOpacity(a),(o+=i/.5)>1&&(o=1)}}n<0&&(n=0,o=1);for(s=0;s<e.length;s++){if(!((a=e[s].partsIndex)<0))if(n==s)t.setPartsOpacity(a,o);else{var c=t.getPartsOpacity(a),h=void 0;(1-(h=o<r?-.5*o/r+1:(1-o)*r/.5))*(1-o)>.15&&(h=1-.15/(1-o)),c>h&&(c=h),t.setPartsOpacity(a,c)}}},t.prototype.copyOpacityOtherParts=function(t,e){for(var i=0;i<e.length;i++){var n=e[i];if(null!=n.link&&!(n.partsIndex<0))for(var o=t.getPartsOpacity(n.partsIndex),r=0;r<n.link.length;r++){var s=n.link[r];s.partsIndex<0||t.setPartsOpacity(s.partsIndex,o)}}},t}(),g=function(){function t(t){this.paramIndex=-1,this.partsIndex=-1,this.link=null,this.id=t}return t.prototype.initIndex=function(t){this.paramIndex=t.getParamIndex("VISIBLE:"+this.id),this.partsIndex=t.getPartsDataIndex(PartsDataID.getID(this.id)),t.setParamFloat(this.paramIndex,1)},t}(),v=function(){function t(){this.EPSILON=.01,this.faceTargetX=0,this.faceTargetY=0,this.faceX=0,this.faceY=0,this.faceVX=0,this.faceVY=0,this.lastTimeSec=0}return t.prototype.setPoint=function(t,e){this.faceTargetX=t,this.faceTargetY=e},t.prototype.getX=function(){return this.faceX},t.prototype.getY=function(){return this.faceY},t.prototype.update=function(){var e=40/7.5/t.FRAME_RATE;if(0!=this.lastTimeSec){var i=UtSystem.getUserTimeMSec(),n=(i-this.lastTimeSec)*t.FRAME_RATE/1e3;this.lastTimeSec=i;var o=n*e/(.15*t.FRAME_RATE),r=this.faceTargetX-this.faceX,s=this.faceTargetY-this.faceY;if(!(Math.abs(r)<=this.EPSILON&&Math.abs(s)<=this.EPSILON)){var a=Math.sqrt(r*r+s*s),l=e*s/a,c=e*r/a-this.faceVX,h=l-this.faceVY,u=Math.sqrt(c*c+h*h);(u<-o||u>o)&&(c*=o/u,h*=o/u,u=o),this.faceVX+=c,this.faceVY+=h;var d=.5*(Math.sqrt(o*o+16*o*a-8*o*a)-o),p=Math.sqrt(this.faceVX*this.faceVX+this.faceVY*this.faceVY);p>d&&(this.faceVX*=d/p,this.faceVY*=d/p),this.faceX+=this.faceVX,this.faceY+=this.faceVY}}else this.lastTimeSec=UtSystem.getUserTimeMSec()},t}();v.FRAME_RATE=30;var y=function(t){function e(){var e=t.call(this)||this;return e.screenLeft=null,e.screenRight=null,e.screenTop=null,e.screenBottom=null,e.maxLeft=null,e.maxRight=null,e.maxTop=null,e.maxBottom=null,e.max=Number.MAX_VALUE,e.min=0,e}return o(e,t),e.prototype.getMaxScale=function(){return this.max},e.prototype.getMinScale=function(){return this.min},e.prototype.setMaxScale=function(t){this.max=t},e.prototype.setMinScale=function(t){this.min=t},e.prototype.isMaxScale=function(){return this.getScaleX()==this.max},e.prototype.isMinScale=function(){return this.getScaleX()==this.min},e.prototype.adjustTranslate=function(t,e){this.tr[0]*this.maxLeft+(this.tr[12]+t)>this.screenLeft&&(t=this.screenLeft-this.tr[0]*this.maxLeft-this.tr[12]),this.tr[0]*this.maxRight+(this.tr[12]+t)<this.screenRight&&(t=this.screenRight-this.tr[0]*this.maxRight-this.tr[12]),this.tr[5]*this.maxTop+(this.tr[13]+e)<this.screenTop&&(e=this.screenTop-this.tr[5]*this.maxTop-this.tr[13]),this.tr[5]*this.maxBottom+(this.tr[13]+e)>this.screenBottom&&(e=this.screenBottom-this.tr[5]*this.maxBottom-this.tr[13]);var i=[1,0,0,0,0,1,0,0,0,0,1,0,t,e,0,1];u.mul(i,this.tr,this.tr)},e.prototype.adjustScale=function(t,e,i){var n=i*this.tr[0];n<this.min?this.tr[0]>0&&(i=this.min/this.tr[0]):n>this.max&&this.tr[0]>0&&(i=this.max/this.tr[0]);var o=[1,0,0,0,0,1,0,0,0,0,1,0,t,e,0,1],r=[i,0,0,0,0,i,0,0,0,0,1,0,0,0,0,1],s=[1,0,0,0,0,1,0,0,0,0,1,0,-t,-e,0,1];u.mul(s,this.tr,this.tr),u.mul(r,this.tr,this.tr),u.mul(o,this.tr,this.tr)},e.prototype.setScreenRect=function(t,e,i,n){this.screenLeft=t,this.screenRight=e,this.screenTop=n,this.screenBottom=i},e.prototype.setMaxScreenRect=function(t,e,i,n){this.maxLeft=t,this.maxRight=e,this.maxTop=n,this.maxBottom=i},e.prototype.getScreenLeft=function(){return this.screenLeft},e.prototype.getScreenRight=function(){return this.screenRight},e.prototype.getScreenBottom=function(){return this.screenBottom},e.prototype.getScreenTop=function(){return this.screenTop},e.prototype.getMaxLeft=function(){return this.maxLeft},e.prototype.getMaxRight=function(){return this.maxRight},e.prototype.getMaxBottom=function(){return this.maxBottom},e.prototype.getMaxTop=function(){return this.maxTop},e}(u),M=function(){function t(){}return t.getPlatformManager=function(){return t.platformManager},t.setPlatformManager=function(e){t.platformManager=e},t}();M.platformManager=null;var S=2,T=.8,w=-1,I=1,x=-2,E=2,P=-2,_=2,b=1,L=2,A=3,O="idle",R="tap_body",N="pinch_in",D="pinch_out",F="head",j="body",Y=function(){function t(){}return t.reset=function(){this.depth=0},t.loadIdentity=function(){for(var t=0;t<16;t++)this.currentMatrix[t]=t%5==0?1:0},t.push=function(){this.depth;var t=16*(this.depth+1);this.matrixStack.length<t+16&&(this.matrixStack.length=t+16);for(var e=0;e<16;e++)this.matrixStack[t+e]=this.currentMatrix[e];this.depth++},t.pop=function(){this.depth--,this.depth<0&&(this.depth=0);for(var t=16*this.depth,e=0;e<16;e++)this.currentMatrix[e]=this.matrixStack[t+e]},t.getMatrix=function(){return this.currentMatrix},t.multMatrix=function(t){var e,i,n;for(e=0;e<16;e++)this.tmp[e]=0;for(e=0;e<4;e++)for(i=0;i<4;i++)for(n=0;n<4;n++)this.tmp[e+4*i]+=this.currentMatrix[e+4*n]*t[n+4*i];for(e=0;e<16;e++)this.currentMatrix[e]=this.tmp[e]},t}();Y.matrixStack=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],Y.depth=0,Y.currentMatrix=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],Y.tmp=new Array(16);var C=function(){function t(){this.NAME="name",this.ID="id",this.MODEL="model",this.TEXTURES="textures",this.HIT_AREAS="hit_areas",this.PHYSICS="physics",this.POSE="pose",this.EXPRESSIONS="expressions",this.MOTION_GROUPS="motions",this.SOUND="sound",this.FADE_IN="fade_in",this.FADE_OUT="fade_out",this.LAYOUT="layout",this.INIT_PARAM="init_param",this.INIT_PARTS_VISIBLE="init_parts_visible",this.VALUE="val",this.FILE="file",this.json={}}return t.prototype.loadModelSetting=function(t,e){var i=this;M.getPlatformManager().loadBytes(t,(function(t){var n=String.fromCharCode.apply(null,new Uint8Array(t));i.json=JSON.parse(n),e()}))},t.prototype.getTextureFile=function(t){return null==this.json[this.TEXTURES]||null==this.json[this.TEXTURES][t]?null:this.json[this.TEXTURES][t]},t.prototype.getModelFile=function(){return this.json[this.MODEL]},t.prototype.getTextureNum=function(){return null==this.json[this.TEXTURES]?0:this.json[this.TEXTURES].length},t.prototype.getHitAreaNum=function(){return null==this.json[this.HIT_AREAS]?0:this.json[this.HIT_AREAS].length},t.prototype.getHitAreaID=function(t){return null==this.json[this.HIT_AREAS]||null==this.json[this.HIT_AREAS][t]?null:this.json[this.HIT_AREAS][t][this.ID]},t.prototype.getHitAreaName=function(t){return null==this.json[this.HIT_AREAS]||null==this.json[this.HIT_AREAS][t]?null:this.json[this.HIT_AREAS][t][this.NAME]},t.prototype.getPhysicsFile=function(){return this.json[this.PHYSICS]},t.prototype.getPoseFile=function(){return this.json[this.POSE]},t.prototype.getExpressionNum=function(){return null==this.json[this.EXPRESSIONS]?0:this.json[this.EXPRESSIONS].length},t.prototype.getExpressionFile=function(t){return null==this.json[this.EXPRESSIONS]?null:this.json[this.EXPRESSIONS][t][this.FILE]},t.prototype.getExpressionName=function(t){return null==this.json[this.EXPRESSIONS]?null:this.json[this.EXPRESSIONS][t][this.NAME]},t.prototype.getLayout=function(){return this.json[this.LAYOUT]},t.prototype.getInitParamNum=function(){return null==this.json[this.INIT_PARAM]?0:this.json[this.INIT_PARAM].length},t.prototype.getMotionNum=function(t){return null==this.json[this.MOTION_GROUPS]||null==this.json[this.MOTION_GROUPS][t]?0:this.json[this.MOTION_GROUPS][t].length},t.prototype.getMotionFile=function(t,e){return null==this.json[this.MOTION_GROUPS]||null==this.json[this.MOTION_GROUPS][t]||null==this.json[this.MOTION_GROUPS][t][e]?null:this.json[this.MOTION_GROUPS][t][e][this.FILE]},t.prototype.getMotionSound=function(t,e){return null==this.json[this.MOTION_GROUPS]||null==this.json[this.MOTION_GROUPS][t]||null==this.json[this.MOTION_GROUPS][t][e]||null==this.json[this.MOTION_GROUPS][t][e][this.SOUND]?null:this.json[this.MOTION_GROUPS][t][e][this.SOUND]},t.prototype.getMotionFadeIn=function(t,e){return null==this.json[this.MOTION_GROUPS]||null==this.json[this.MOTION_GROUPS][t]||null==this.json[this.MOTION_GROUPS][t][e]||null==this.json[this.MOTION_GROUPS][t][e][this.FADE_IN]?1e3:this.json[this.MOTION_GROUPS][t][e][this.FADE_IN]},t.prototype.getMotionFadeOut=function(t,e){return null==this.json[this.MOTION_GROUPS]||null==this.json[this.MOTION_GROUPS][t]||null==this.json[this.MOTION_GROUPS][t][e]||null==this.json[this.MOTION_GROUPS][t][e][this.FADE_OUT]?1e3:this.json[this.MOTION_GROUPS][t][e][this.FADE_OUT]},t.prototype.getInitParamID=function(t){return null==this.json[this.INIT_PARAM]||null==this.json[this.INIT_PARAM][t]?null:this.json[this.INIT_PARAM][t][this.ID]},t.prototype.getInitParamValue=function(t){return null==this.json[this.INIT_PARAM]||null==this.json[this.INIT_PARAM][t]?NaN:this.json[this.INIT_PARAM][t][this.VALUE]},t.prototype.getInitPartsVisibleNum=function(){return null==this.json[this.INIT_PARTS_VISIBLE]?0:this.json[this.INIT_PARTS_VISIBLE].length},t.prototype.getInitPartsVisibleID=function(t){return null==this.json[this.INIT_PARTS_VISIBLE]||null==this.json[this.INIT_PARTS_VISIBLE][t]?null:this.json[this.INIT_PARTS_VISIBLE][t][this.ID]},t.prototype.getInitPartsVisibleValue=function(t){return null==this.json[this.INIT_PARTS_VISIBLE]||null==this.json[this.INIT_PARTS_VISIBLE][t]?NaN:this.json[this.INIT_PARTS_VISIBLE][t][this.VALUE]},t}(),X=this&&this.__extends||function(){var t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},t(e,i)};return function(e,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),B=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))((function(o,r){function s(t){try{l(n.next(t))}catch(t){r(t)}}function a(t){try{l(n.throw(t))}catch(t){r(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(s,a)}l((n=n.apply(t,e||[])).next())}))},U=this&&this.__generator||function(t,e){var i,n,o,r={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return s.next=a(0),s.throw=a(1),s.return=a(2),"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(a){return function(l){return function(a){if(i)throw new TypeError("Generator is already executing.");for(;s&&(s=0,a[0]&&(r=0)),r;)try{if(i=1,n&&(o=2&a[0]?n.return:a[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,a[1])).done)return o;switch(n=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return r.label++,{value:a[1],done:!1};case 5:r.label++,n=a[1],a=[0];continue;case 7:a=r.ops.pop(),r.trys.pop();continue;default:if(!(o=r.trys,(o=o.length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){r=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){r.label=a[1];break}if(6===a[0]&&r.label<o[1]){r.label=o[1],o=a;break}if(o&&r.label<o[2]){r.label=o[2],r.ops.push(a);break}o[2]&&r.ops.pop(),r.trys.pop();continue}a=e.call(t,r)}catch(t){a=[6,t],n=0}finally{i=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,l])}}},k=function(t){function e(){var e=t.call(this)||this;return e.modelHomeDir="",e.modelSetting=null,e.tmpMatrix=[],e}return X(e,t),e.prototype.loadJSON=function(t){var e=this,i=this.modelHomeDir+this.modelSetting.getModelFile();this.loadModelData(i,(function(i){for(var n=0;n<e.modelSetting.getTextureNum();n++){var o=e.modelHomeDir+e.modelSetting.getTextureFile(n);e.loadTexture(n,o,(function(){if(e.isTexLoaded){if(e.modelSetting.getExpressionNum()>0){e.expressions={};for(var i=0;i<e.modelSetting.getExpressionNum();i++){var n=e.modelSetting.getExpressionName(i),o=e.modelHomeDir+e.modelSetting.getExpressionFile(i);e.loadExpression(n,o)}}else e.expressionManager=null,e.expressions={};if(null==e.eyeBlink&&(e.eyeBlink=new c),null!=e.modelSetting.getPhysicsFile()?e.loadPhysics(e.modelHomeDir+e.modelSetting.getPhysicsFile()):e.physics=null,null!=e.modelSetting.getPoseFile()?e.loadPose(e.modelHomeDir+e.modelSetting.getPoseFile(),(function(){e.pose.updateParam(e.live2DModel)})):e.pose=null,null!=e.modelSetting.getLayout()){var r=e.modelSetting.getLayout();null!=r.width&&e.modelMatrix.setWidth(r.width),null!=r.height&&e.modelMatrix.setHeight(r.height),null!=r.x&&e.modelMatrix.setX(r.x),null!=r.y&&e.modelMatrix.setY(r.y),null!=r.center_x&&e.modelMatrix.centerX(r.center_x),null!=r.center_y&&e.modelMatrix.centerY(r.center_y),null!=r.top&&e.modelMatrix.top(r.top),null!=r.bottom&&e.modelMatrix.bottom(r.bottom),null!=r.left&&e.modelMatrix.left(r.left),null!=r.right&&e.modelMatrix.right(r.right)}for(i=0;i<e.modelSetting.getInitParamNum();i++)e.live2DModel.setParamFloat(e.modelSetting.getInitParamID(i),e.modelSetting.getInitParamValue(i));for(i=0;i<e.modelSetting.getInitPartsVisibleNum();i++)e.live2DModel.setPartsOpacity(e.modelSetting.getInitPartsVisibleID(i),e.modelSetting.getInitPartsVisibleValue(i));e.live2DModel.saveParam(),e.preloadMotionGroup(O),e.mainMotionManager.stopAllMotions(),e.setUpdating(!1),e.setInitialized(!0),"function"==typeof t&&t()}}))}}))},e.prototype.loadModelSetting=function(t,e){return B(this,void 0,void 0,(function(){var i=this;return U(this,(function(n){switch(n.label){case 0:return this.setUpdating(!0),this.setInitialized(!1),this.modelHomeDir=t.substring(0,t.lastIndexOf("/")+1),this.modelSetting=new C,this.modelSetting.json=e,[4,new Promise((function(t){return i.loadJSON(t)}))];case 1:return n.sent(),[2]}}))}))},e.prototype.load=function(t,e,i){var n=this;this.setUpdating(!0),this.setInitialized(!1),this.modelHomeDir=e.substring(0,e.lastIndexOf("/")+1),this.modelSetting=new C,this.modelSetting.loadModelSetting(e,(function(){n.loadJSON(i)}))},e.prototype.release=function(t){var e=M.getPlatformManager();t.deleteTexture(e.texture)},e.prototype.preloadMotionGroup=function(t){for(var e=this,i=function(i){var o=n.modelSetting.getMotionFile(t,i);n.loadMotion(o,n.modelHomeDir+o,(function(n){n.setFadeIn(e.modelSetting.getMotionFadeIn(t,i)),n.setFadeOut(e.modelSetting.getMotionFadeOut(t,i))}))},n=this,o=0;o<this.modelSetting.getMotionNum(t);o++)i(o)},e.prototype.update=function(){if(null!=this.live2DModel){var t=2*((UtSystem.getUserTimeMSec()-this.startTimeMSec)/1e3)*Math.PI;this.mainMotionManager.isFinished()&&this.startRandomMotion(O,b),this.live2DModel.loadParam(),this.mainMotionManager.updateParam(this.live2DModel)||null!=this.eyeBlink&&this.eyeBlink.updateParam(this.live2DModel),this.live2DModel.saveParam(),null==this.expressionManager||null==this.expressions||this.expressionManager.isFinished()||this.expressionManager.updateParam(this.live2DModel),this.live2DModel.addToParamFloat("PARAM_ANGLE_X",30*this.dragX,1),this.live2DModel.addToParamFloat("PARAM_ANGLE_Y",30*this.dragY,1),this.live2DModel.addToParamFloat("PARAM_ANGLE_Z",this.dragX*this.dragY*-30,1),this.live2DModel.addToParamFloat("PARAM_BODY_ANGLE_X",10*this.dragX,1),this.live2DModel.addToParamFloat("PARAM_EYE_BALL_X",this.dragX,1),this.live2DModel.addToParamFloat("PARAM_EYE_BALL_Y",this.dragY,1),this.live2DModel.addToParamFloat("PARAM_ANGLE_X",Number(15*Math.sin(t/6.5345)),.5),this.live2DModel.addToParamFloat("PARAM_ANGLE_Y",Number(8*Math.sin(t/3.5345)),.5),this.live2DModel.addToParamFloat("PARAM_ANGLE_Z",Number(10*Math.sin(t/5.5345)),.5),this.live2DModel.addToParamFloat("PARAM_BODY_ANGLE_X",Number(4*Math.sin(t/15.5345)),.5),this.live2DModel.setParamFloat("PARAM_BREATH",Number(.5+.5*Math.sin(t/3.2345)),1),null!=this.physics&&this.physics.updateParam(this.live2DModel),null==this.lipSync&&this.live2DModel.setParamFloat("PARAM_MOUTH_OPEN_Y",this.lipSyncValue),null!=this.pose&&this.pose.updateParam(this.live2DModel),this.live2DModel.update()}else n.error("Failed to update.")},e.prototype.setRandomExpression=function(){var t=[];for(var e in this.expressions)t.push(e);var i=parseInt(Math.random()*t.length);this.setExpression(t[i])},e.prototype.startRandomMotion=function(t,e){var i=this.modelSetting.getMotionNum(t),n=parseInt(Math.random()*i);this.startMotion(t,n,e)},e.prototype.startMotion=function(t,e,i){var o=this,r=this.modelSetting.getMotionFile(t,e);if(null!=r&&""!=r){if(i==A)this.mainMotionManager.setReservePriority(i);else if(!this.mainMotionManager.reserveMotion(i))return void n.trace("Motion is running.");var s;null==this.motions[t]?this.loadMotion(null,this.modelHomeDir+r,(function(n){s=n,o.setFadeInFadeOut(t,e,i,s)})):(s=this.motions[t],this.setFadeInFadeOut(t,e,i,s))}else n.error("Failed to motion.")},e.prototype.setFadeInFadeOut=function(t,e,i,o){var r=this.modelSetting.getMotionFile(t,e);if(o.setFadeIn(this.modelSetting.getMotionFadeIn(t,e)),o.setFadeOut(this.modelSetting.getMotionFadeOut(t,e)),n.trace("Start motion : "+r),null==this.modelSetting.getMotionSound(t,e))this.mainMotionManager.startMotionPrio(o,i);else{var s=this.modelSetting.getMotionSound(t,e),a=document.createElement("audio");a.src=this.modelHomeDir+s,n.trace("Start sound : "+s),a.play(),this.mainMotionManager.startMotionPrio(o,i)}},e.prototype.setExpression=function(t){var e=this.expressions[t];n.trace("Expression : "+t),this.expressionManager.startMotion(e,!1)},e.prototype.draw=function(t){Y.push(),Y.multMatrix(this.modelMatrix.getArray()),this.tmpMatrix=Y.getMatrix(),this.live2DModel.setMatrix(this.tmpMatrix),this.live2DModel.draw(),Y.pop()},e.prototype.hitTest=function(t,e,i){for(var n=this.modelSetting.getHitAreaNum(),o=0;o<n;o++)if(t==this.modelSetting.getHitAreaName(o)){var r=this.modelSetting.getHitAreaID(o);return this.hitTestSimple(r,e,i)}return!1},e}(r),G=function(){function t(){this.cache={}}return t.prototype.loadBytes=function(t,e){var i=this;if(t in this.cache)return e(this.cache[t]);fetch(t).then((function(t){return t.arrayBuffer()})).then((function(n){i.cache[t]=n,e(n)}))},t.prototype.loadLive2DModel=function(t,e){var i=null;this.loadBytes(t,(function(t){i=Live2DModelWebGL.loadModel(t),e(i)}))},t.prototype.loadTexture=function(t,e,i,o){var r=new Image;r.crossOrigin="anonymous",r.src=i,r.onload=function(){var i=document.getElementById("live2d").getContext("webgl",{premultipliedAlpha:!0,preserveDrawingBuffer:!0}),s=i.createTexture();if(!s)return n.error("Failed to generate gl texture name."),-1;0==t.isPremultipliedAlpha()&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,1),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,s),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,r),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR_MIPMAP_NEAREST),i.generateMipmap(i.TEXTURE_2D),t.setTexture(e,s),s=null,"function"==typeof o&&o()},r.onerror=function(){n.error("Failed to load image : "+i)}},t.prototype.jsonParseFromBytes=function(t){var e,i=new Uint8Array(t,0,3);return e=239==i[0]&&187==i[1]&&191==i[2]?String.fromCharCode.apply(null,new Uint8Array(t,3)):String.fromCharCode.apply(null,new Uint8Array(t)),JSON.parse(e)},t}(),H=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))((function(o,r){function s(t){try{l(n.next(t))}catch(t){r(t)}}function a(t){try{l(n.throw(t))}catch(t){r(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(s,a)}l((n=n.apply(t,e||[])).next())}))},V=this&&this.__generator||function(t,e){var i,n,o,r={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return s.next=a(0),s.throw=a(1),s.return=a(2),"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(a){return function(l){return function(a){if(i)throw new TypeError("Generator is already executing.");for(;s&&(s=0,a[0]&&(r=0)),r;)try{if(i=1,n&&(o=2&a[0]?n.return:a[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,a[1])).done)return o;switch(n=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return r.label++,{value:a[1],done:!1};case 5:r.label++,n=a[1],a=[0];continue;case 7:a=r.ops.pop(),r.trys.pop();continue;default:if(!(o=r.trys,(o=o.length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){r=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){r.label=a[1];break}if(6===a[0]&&r.label<o[1]){r.label=o[1],o=a;break}if(o&&r.label<o[2]){r.label=o[2],r.ops.push(a);break}o[2]&&r.ops.pop(),r.trys.pop();continue}a=e.call(t,r)}catch(t){a=[6,t],n=0}finally{i=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,l])}}},z=function(){function t(){this.model=null,this.reloading=!1,Live2D.init(),M.setPlatformManager(new G)}return t.prototype.getModel=function(){return this.model},t.prototype.releaseModel=function(t){this.model&&(this.model.release(t),this.model=null)},t.prototype.changeModel=function(t,e){return H(this,void 0,void 0,(function(){var i=this;return V(this,(function(n){return[2,new Promise((function(n,o){if(!i.reloading){i.reloading=!0;var r=i.model,s=new k;s.load(t,e,(function(){r&&r.release(t),i.model=s,i.reloading=!1,n()}))}}))]}))}))},t.prototype.changeModelWithJSON=function(t,e,i){return H(this,void 0,void 0,(function(){var n,o;return V(this,(function(r){switch(r.label){case 0:return this.reloading?[2]:(this.reloading=!0,n=this.model,[4,(o=new k).loadModelSetting(e,i)]);case 1:return r.sent(),n&&n.release(t),this.model=o,this.reloading=!1,[2]}}))}))},t.prototype.setDrag=function(t,e){this.model&&this.model.setDrag(t,e)},t.prototype.maxScaleEvent=function(){n.trace("Max scale event."),this.model&&this.model.startRandomMotion(N,L)},t.prototype.minScaleEvent=function(){n.trace("Min scale event."),this.model&&this.model.startRandomMotion(D,L)},t.prototype.tapEvent=function(t,e){return n.trace("tapEvent view x:"+t+" y:"+e),!!this.model&&(this.model.hitTest(F,t,e)?(n.trace("Tap face."),this.model.setRandomExpression()):this.model.hitTest(j,t,e)&&(n.trace("Tap body."),this.model.startRandomMotion(R,L)),!0)},t}(),W=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))((function(o,r){function s(t){try{l(n.next(t))}catch(t){r(t)}}function a(t){try{l(n.throw(t))}catch(t){r(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(s,a)}l((n=n.apply(t,e||[])).next())}))},J=this&&this.__generator||function(t,e){var i,n,o,r={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return s.next=a(0),s.throw=a(1),s.return=a(2),"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(a){return function(l){return function(a){if(i)throw new TypeError("Generator is already executing.");for(;s&&(s=0,a[0]&&(r=0)),r;)try{if(i=1,n&&(o=2&a[0]?n.return:a[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,a[1])).done)return o;switch(n=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return r.label++,{value:a[1],done:!1};case 5:r.label++,n=a[1],a=[0];continue;case 7:a=r.ops.pop(),r.trys.pop();continue;default:if(!(o=r.trys,(o=o.length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){r=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){r.label=a[1];break}if(6===a[0]&&r.label<o[1]){r.label=o[1],o=a;break}if(o&&r.label<o[2]){r.label=o[2],r.ops.push(a);break}o[2]&&r.ops.pop(),r.trys.pop();continue}a=e.call(t,r)}catch(t){a=[6,t],n=0}finally{i=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,l])}}},q=function(){function t(){this.live2DMgr=new z,this.isDrawStart=!1,this.gl=null,this.canvas=null,this.dragMgr=null,this.viewMatrix=null,this.projMatrix=null,this.deviceToScreen=null,this.drag=!1,this.oldLen=0,this.lastMouseX=0,this.lastMouseY=0}return t.prototype.initL2dCanvas=function(t){this.canvas=document.getElementById(t),this.canvas.addEventListener&&(this.canvas.addEventListener("mousewheel",this.mouseEvent.bind(this),!1),this.canvas.addEventListener("click",this.mouseEvent.bind(this),!1),this.canvas.addEventListener("mousedown",this.mouseEvent.bind(this),!1),this.canvas.addEventListener("mousemove",this.mouseEvent.bind(this),!1),this.canvas.addEventListener("mouseup",this.mouseEvent.bind(this),!1),this.canvas.addEventListener("mouseout",this.mouseEvent.bind(this),!1),this.canvas.addEventListener("contextmenu",this.mouseEvent.bind(this),!1),this.canvas.addEventListener("touchstart",this.touchEvent.bind(this),!1),this.canvas.addEventListener("touchend",this.touchEvent.bind(this),!1),this.canvas.addEventListener("touchmove",this.touchEvent.bind(this),!1))},t.prototype.init=function(t,e,i){return W(this,void 0,void 0,(function(){var o,r,s,a,l,c,h;return J(this,(function(d){switch(d.label){case 0:return this.initL2dCanvas(t),o=this.canvas.width,r=this.canvas.height,this.dragMgr=new v,a=w,l=I,c=-(s=r/o),h=s,this.viewMatrix=new y,this.viewMatrix.setScreenRect(a,l,c,h),this.viewMatrix.setMaxScreenRect(x,E,P,_),this.viewMatrix.setMaxScale(S),this.viewMatrix.setMinScale(T),this.projMatrix=new u,this.projMatrix.multScale(1,o/r),this.deviceToScreen=new u,this.deviceToScreen.multTranslate(-o/2,-r/2),this.deviceToScreen.multScale(2/o,-2/o),this.gl=this.canvas.getContext("webgl",{premultipliedAlpha:!0,preserveDrawingBuffer:!0}),this.gl?(Live2D.setGL(this.gl),this.gl.clearColor(0,0,0,0),[4,this.changeModelWithJSON(e,i)]):(n.error("Failed to create WebGL context."),[2]);case 1:return d.sent(),this.startDraw(),[2]}}))}))},t.prototype.startDraw=function(){var t=this;if(!this.isDrawStart){this.isDrawStart=!0;var e=function(){t.draw(),(window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame)(e,t.canvas)};e()}},t.prototype.draw=function(){Y.reset(),Y.loadIdentity(),this.dragMgr.update(),this.live2DMgr.setDrag(this.dragMgr.getX(),this.dragMgr.getY()),this.gl.clear(this.gl.COLOR_BUFFER_BIT),Y.multMatrix(this.projMatrix.getArray()),Y.multMatrix(this.viewMatrix.getArray()),Y.push();var t=this.live2DMgr.getModel();null!=t&&(t.initialized&&!t.updating&&(t.update(),t.draw(this.gl)),Y.pop())},t.prototype.changeModel=function(t){return W(this,void 0,void 0,(function(){return J(this,(function(e){switch(e.label){case 0:return[4,this.live2DMgr.changeModel(this.gl,t)];case 1:return e.sent(),[2]}}))}))},t.prototype.changeModelWithJSON=function(t,e){return W(this,void 0,void 0,(function(){return J(this,(function(i){switch(i.label){case 0:return[4,this.live2DMgr.changeModelWithJSON(this.gl,t,e)];case 1:return i.sent(),[2]}}))}))},t.prototype.modelScaling=function(t){var e=this.viewMatrix.isMaxScale(),i=this.viewMatrix.isMinScale();this.viewMatrix.adjustScale(0,0,t),e||this.viewMatrix.isMaxScale()&&this.live2DMgr.maxScaleEvent(),i||this.viewMatrix.isMinScale()&&this.live2DMgr.minScaleEvent()},t.prototype.modelTurnHead=function(t){this.drag=!0;var e=t.target.getBoundingClientRect(),i=this.transformScreenX(t.clientX-e.left),o=this.transformScreenY(t.clientY-e.top),r=this.transformViewX(t.clientX-e.left),s=this.transformViewY(t.clientY-e.top);n.trace("onMouseDown device( x:"+t.clientX+" y:"+t.clientY+" ) view( x:"+r+" y:"+s+")"),this.lastMouseX=i,this.lastMouseY=o,this.dragMgr.setPoint(r,s),this.live2DMgr.tapEvent(r,s)},t.prototype.followPointer=function(t){var e=t.target.getBoundingClientRect(),i=this.transformScreenX(t.clientX-e.left),o=this.transformScreenY(t.clientY-e.top),r=this.transformViewX(t.clientX-e.left),s=this.transformViewY(t.clientY-e.top);n.trace("onMouseMove device( x:"+t.clientX+" y:"+t.clientY+" ) view( x:"+r+" y:"+s+")"),this.drag&&(this.lastMouseX=i,this.lastMouseY=o,this.dragMgr.setPoint(r,s))},t.prototype.lookFront=function(){this.drag&&(this.drag=!1),this.dragMgr.setPoint(0,0)},t.prototype.mouseEvent=function(t){if(t.preventDefault(),"mousewheel"==t.type){if(t.clientX<0||this.canvas.clientWidth<t.clientX||t.clientY<0||this.canvas.clientHeight<t.clientY)return;t.wheelDelta>0?this.modelScaling(1.1):this.modelScaling(.9)}else if("mousedown"==t.type){if("button"in t&&0!=t.button)return;this.modelTurnHead(t)}else if("mousemove"==t.type)this.followPointer(t);else if("mouseup"==t.type){if("button"in t&&0!=t.button)return;this.lookFront()}else"mouseout"==t.type&&this.lookFront()},t.prototype.touchEvent=function(t){t.preventDefault();var e=t.touches[0];if("touchstart"==t.type)1==t.touches.length&&this.modelTurnHead(e);else if("touchmove"==t.type){if(this.followPointer(e),2==t.touches.length){var i=t.touches[0],n=t.touches[1],o=Math.pow(i.pageX-n.pageX,2)+Math.pow(i.pageY-n.pageY,2);this.oldLen-o<0?this.modelScaling(1.025):this.modelScaling(.975),this.oldLen=o}}else"touchend"==t.type&&this.lookFront()},t.prototype.transformViewX=function(t){var e=this.deviceToScreen.transformX(t);return this.viewMatrix.invertTransformX(e)},t.prototype.transformViewY=function(t){var e=this.deviceToScreen.transformY(t);return this.viewMatrix.invertTransformY(e)},t.prototype.transformScreenX=function(t){return this.deviceToScreen.transformX(t)},t.prototype.transformScreenY=function(t){return this.deviceToScreen.transformY(t)},t}();function Z(t){return Array.isArray(t)?t[Math.floor(Math.random()*t.length)]:t}var Q=null;function K(t,e,i){if(t&&!(sessionStorage.getItem("waifu-text")&&Number(sessionStorage.getItem("waifu-text"))>i)){Q&&(clearTimeout(Q),Q=null),t=Z(t),sessionStorage.setItem("waifu-text",String(i));var n=document.getElementById("waifu-tips");n.innerHTML=t,n.classList.add("waifu-tips-active"),Q=setTimeout((function(){sessionStorage.removeItem("waifu-text"),n.classList.remove("waifu-tips-active")}),e)}}var $=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))((function(o,r){function s(t){try{l(n.next(t))}catch(t){r(t)}}function a(t){try{l(n.throw(t))}catch(t){r(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(s,a)}l((n=n.apply(t,e||[])).next())}))},tt=this&&this.__generator||function(t,e){var i,n,o,r={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return s.next=a(0),s.throw=a(1),s.return=a(2),"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(a){return function(l){return function(a){if(i)throw new TypeError("Generator is already executing.");for(;s&&(s=0,a[0]&&(r=0)),r;)try{if(i=1,n&&(o=2&a[0]?n.return:a[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,a[1])).done)return o;switch(n=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return r.label++,{value:a[1],done:!1};case 5:r.label++,n=a[1],a=[0];continue;case 7:a=r.ops.pop(),r.trys.pop();continue;default:if(!(o=r.trys,(o=o.length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){r=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){r.label=a[1];break}if(6===a[0]&&r.label<o[1]){r.label=o[1],o=a;break}if(o&&r.label<o[2]){r.label=o[2],r.ops.push(a);break}o[2]&&r.ops.pop(),r.trys.pop();continue}a=e.call(t,r)}catch(t){a=[6,t],n=0}finally{i=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,l])}}};var et={hitokoto:{icon:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">\x3c!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc. --\x3e<path d="M512 240c0 114.9-114.6 208-256 208c-37.1 0-72.3-6.4-104.1-17.9c-11.9 8.7-31.3 20.6-54.3 30.6C73.6 471.1 44.7 480 16 480c-6.5 0-12.3-3.9-14.8-9.9c-2.5-6-1.1-12.8 3.4-17.4c0 0 0 0 0 0s0 0 0 0s0 0 0 0c0 0 0 0 0 0l.3-.3c.3-.3 .7-.7 1.3-1.4c1.1-1.2 2.8-3.1 4.9-5.7c4.1-5 9.6-12.4 15.2-21.6c10-16.6 19.5-38.4 21.4-62.9C17.7 326.8 0 285.1 0 240C0 125.1 114.6 32 256 32s256 93.1 256 208z"/></svg>',callback:function(){return $(this,void 0,void 0,(function(){var t,e;return tt(this,(function(i){switch(i.label){case 0:return[4,fetch("https://v1.hitokoto.cn")];case 1:return[4,i.sent().json()];case 2:return t=i.sent(),e="这句一言来自 <span>「".concat(t.from,"」</span>，是 <span>").concat(t.creator,"</span> 在 hitokoto.cn 投稿的。"),K(t.hitokoto,6e3,9),setTimeout((function(){K(e,4e3,9)}),6e3),[2]}}))}))}},asteroids:{icon:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">\x3c!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc. --\x3e<path d="M498.1 5.6c10.1 7 15.4 19.1 13.5 31.2l-64 416c-1.5 9.7-7.4 18.2-16 23s-18.9 5.4-28 1.6L284 427.7l-68.5 74.1c-8.9 9.7-22.9 12.9-35.2 8.1S160 493.2 160 480l0-83.6c0-4 1.5-7.8 4.2-10.8L331.8 202.8c5.8-6.3 5.6-16-.4-22s-15.7-6.4-22-.7L106 360.8 17.7 316.6C7.1 311.3 .3 300.7 0 288.9s5.9-22.8 16.1-28.7l448-256c10.7-6.1 23.9-5.5 34 1.4z"/></svg>',callback:function(){if(window.Asteroids)window.ASTEROIDSPLAYERS||(window.ASTEROIDSPLAYERS=[]),window.ASTEROIDSPLAYERS.push(new window.Asteroids);else{var t=document.createElement("script");t.src="https://fastly.jsdelivr.net/gh/stevenjoezhang/asteroids/asteroids.js",document.head.appendChild(t)}}},"switch-model":{icon:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">\x3c!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc. --\x3e<path d="M399 384.2C376.9 345.8 335.4 320 288 320l-64 0c-47.4 0-88.9 25.8-111 64.2c35.2 39.2 86.2 63.8 143 63.8s107.8-24.7 143-63.8zM0 256a256 256 0 1 1 512 0A256 256 0 1 1 0 256zm256 16a72 72 0 1 0 0-144 72 72 0 1 0 0 144z"/></svg>',callback:function(){}},"switch-texture":{icon:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">\x3c!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc. --\x3e<path d="M320 64A64 64 0 1 0 192 64a64 64 0 1 0 128 0zm-96 96c-35.3 0-64 28.7-64 64l0 48c0 17.7 14.3 32 32 32l1.8 0 11.1 99.5c1.8 16.2 15.5 28.5 31.8 28.5l38.7 0c16.3 0 30-12.3 31.8-28.5L318.2 304l1.8 0c17.7 0 32-14.3 32-32l0-48c0-35.3-28.7-64-64-64l-64 0zM132.3 394.2c13-2.4 21.7-14.9 19.3-27.9s-14.9-21.7-27.9-19.3c-32.4 5.9-60.9 14.2-82 24.8c-10.5 5.3-20.3 11.7-27.8 19.6C6.4 399.5 0 410.5 0 424c0 21.4 15.5 36.1 29.1 45c14.7 9.6 34.3 17.3 56.4 23.4C130.2 504.7 190.4 512 256 512s125.8-7.3 170.4-19.6c22.1-6.1 41.8-13.8 56.4-23.4c13.7-8.9 29.1-23.6 29.1-45c0-13.5-6.4-24.5-14-32.6c-7.5-7.9-17.3-14.3-27.8-19.6c-21-10.6-49.5-18.9-82-24.8c-13-2.4-25.5 6.3-27.9 19.3s6.3 25.5 19.3 27.9c30.2 5.5 53.7 12.8 69 20.5c3.2 1.6 5.8 3.1 7.9 4.5c3.6 2.4 3.6 7.2 0 9.6c-8.8 5.7-23.1 11.8-43 17.3C374.3 457 318.5 464 256 464s-118.3-7-157.7-17.9c-19.9-5.5-34.2-11.6-43-17.3c-3.6-2.4-3.6-7.2 0-9.6c2.1-1.4 4.8-2.9 7.9-4.5c15.3-7.7 38.8-14.9 69-20.5z"/></svg>',callback:function(){}},photo:{icon:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">\x3c!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc. --\x3e<path d="M220.6 121.2L271.1 96 448 96l0 96-114.8 0c-21.9-15.1-48.5-24-77.2-24s-55.2 8.9-77.2 24L64 192l0-64 128 0c9.9 0 19.7-2.3 28.6-6.8zM0 128L0 416c0 35.3 28.7 64 64 64l384 0c35.3 0 64-28.7 64-64l0-320c0-35.3-28.7-64-64-64L271.1 32c-9.9 0-19.7 2.3-28.6 6.8L192 64l-32 0 0-16c0-8.8-7.2-16-16-16L80 32c-8.8 0-16 7.2-16 16l0 16C28.7 64 0 92.7 0 128zM168 304a88 88 0 1 1 176 0 88 88 0 1 1 -176 0z"/></svg>',callback:function(){K("照好了嘛，是不是很可爱呢？",6e3,9);var t=document.getElementById("live2d");if(t){var e=t.toDataURL(),i=document.createElement("a");i.style.display="none",i.href=e,i.download="live2d-photo.png",document.body.appendChild(i),i.click(),document.body.removeChild(i)}}},info:{icon:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">\x3c!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc. --\x3e<path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM216 336l24 0 0-64-24 0c-13.3 0-24-10.7-24-24s10.7-24 24-24l48 0c13.3 0 24 10.7 24 24l0 88 8 0c13.3 0 24 10.7 24 24s-10.7 24-24 24l-80 0c-13.3 0-24-10.7-24-24s10.7-24 24-24zm40-208a32 32 0 1 1 0 64 32 32 0 1 1 0-64z"/></svg>',callback:function(){open("https://github.com/stevenjoezhang/live2d-widget")}},quit:{icon:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512">\x3c!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc. --\x3e<path d="M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z"/></svg>',callback:function(){localStorage.setItem("waifu-display",Date.now().toString()),K("愿你有一天能与重要的人重逢。",2e3,11);var t=document.getElementById("waifu");t&&(t.style.bottom="-500px",setTimeout((function(){t.style.display="none";var e=document.getElementById("waifu-toggle");e&&e.classList.add("waifu-toggle-active")}),3e3))}}},it=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))((function(o,r){function s(t){try{l(n.next(t))}catch(t){r(t)}}function a(t){try{l(n.throw(t))}catch(t){r(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(s,a)}l((n=n.apply(t,e||[])).next())}))},nt=this&&this.__generator||function(t,e){var i,n,o,r={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return s.next=a(0),s.throw=a(1),s.return=a(2),"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(a){return function(l){return function(a){if(i)throw new TypeError("Generator is already executing.");for(;s&&(s=0,a[0]&&(r=0)),r;)try{if(i=1,n&&(o=2&a[0]?n.return:a[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,a[1])).done)return o;switch(n=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return r.label++,{value:a[1],done:!1};case 5:r.label++,n=a[1],a=[0];continue;case 7:a=r.ops.pop(),r.trys.pop();continue;default:if(!(o=r.trys,(o=o.length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){r=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){r.label=a[1];break}if(6===a[0]&&r.label<o[1]){r.label=o[1],o=a;break}if(o&&r.label<o[2]){r.label=o[2],r.ops.push(a);break}o[2]&&r.ops.pop(),r.trys.pop();continue}a=e.call(t,r)}catch(t){a=[6,t],n=0}finally{i=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,l])}}},ot=function(){function t(t){var e;this.modelList=null;var i=t.apiPath,n=t.cdnPath,o=!1;if("string"==typeof n)o=!0,n.endsWith("/")||(n+="/");else{if("string"!=typeof i)throw"Invalid initWidget argument!";i.endsWith("/")||(i+="/")}var r=parseInt(localStorage.getItem("modelId"),10),s=parseInt(localStorage.getItem("modelTexturesId"),10);(isNaN(r)||isNaN(s))&&(s=0),isNaN(r)&&(r=null!==(e=t.modelId)&&void 0!==e?e:o?0:1),this.useCDN=o,this.apiPath=i||"",this.cdnPath=n||"",this._modelId=r,this._modelTexturesId=s,this.model=new q,this.modelInitialized=!1,this.modelJSONCache={}}return Object.defineProperty(t.prototype,"modelId",{get:function(){return this._modelId},set:function(t){this._modelId=t,localStorage.setItem("modelId",t.toString())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"modelTexturesId",{get:function(){return this._modelTexturesId},set:function(t){this._modelTexturesId=t,localStorage.setItem("modelTexturesId",t.toString())},enumerable:!1,configurable:!0}),t.prototype.fetchWithCache=function(t){return it(this,void 0,void 0,(function(){var e;return nt(this,(function(i){switch(i.label){case 0:return t in this.modelJSONCache?(e=this.modelJSONCache[t],[3,4]):[3,1];case 1:return[4,fetch(t)];case 2:return[4,i.sent().json()];case 3:e=i.sent(),this.modelJSONCache[t]=e,i.label=4;case 4:return[2,e]}}))}))},t.prototype.loadLive2d=function(t,e){return it(this,void 0,void 0,(function(){return nt(this,(function(i){switch(i.label){case 0:return this.modelInitialized?[3,2]:(this.modelInitialized=!0,[4,this.model.init("live2d",t,e)]);case 1:return i.sent(),[3,4];case 2:return[4,this.model.changeModelWithJSON(t,e)];case 3:i.sent(),i.label=4;case 4:return n.info("Model ".concat(t," loaded")),[2]}}))}))},t.prototype.loadModelList=function(){return it(this,void 0,void 0,(function(){return nt(this,(function(t){switch(t.label){case 0:return[4,fetch("".concat(this.cdnPath,"model_list.json"))];case 1:return[4,t.sent().json()];case 2:return[2,t.sent()]}}))}))},t.prototype.loadTextureCache=function(t){return it(this,void 0,void 0,(function(){return nt(this,(function(e){switch(e.label){case 0:return[4,this.fetchWithCache("".concat(this.cdnPath,"model/").concat(t,"/textures.cache"))];case 1:return[2,e.sent()]}}))}))},t.prototype.loadModel=function(t){return it(this,void 0,void 0,(function(){var e,i,n,o,r,s,a,l,c;return nt(this,(function(h){switch(h.label){case 0:return i=(e=this).modelId,n=e.modelTexturesId,this.useCDN?this.modelList?[3,2]:(o=this,[4,this.loadModelList()]):[3,6];case 1:o.modelList=h.sent(),h.label=2;case 2:return r=Z(this.modelList.models[i]),l="".concat(this.cdnPath,"model/").concat(r,"/index.json"),[4,this.loadTextureCache(r)];case 3:return s=h.sent(),[4,this.fetchWithCache(l)];case 4:return c=h.sent(),"string"==typeof(a=s[n])&&(a=[a]),c.textures=a,[4,this.loadLive2d(l,c)];case 5:return h.sent(),[3,9];case 6:return l="".concat(this.apiPath,"get/?id=").concat(i,"-").concat(n),[4,this.fetchWithCache(l)];case 7:return c=h.sent(),[4,this.loadLive2d(l,c)];case 8:h.sent(),h.label=9;case 9:return K(t,4e3,10),[2]}}))}))},t.prototype.loadRandTexture=function(){return it(this,void 0,void 0,(function(){var t,e,i,n,o,r,s,a,l,c;return nt(this,(function(h){switch(h.label){case 0:return e=(t=this).modelId,i=t.modelTexturesId,this.useCDN?this.modelList?[3,2]:(n=this,[4,this.loadModelList()]):[3,6];case 1:n.modelList=h.sent(),h.label=2;case 2:return o=Z(this.modelList.models[e]),r="".concat(this.cdnPath,"model/").concat(o,"/index.json"),[4,this.loadTextureCache(o)];case 3:return s=h.sent(),[4,this.fetchWithCache(r)];case 4:return a=h.sent(),this.modelTexturesId=Math.floor(Math.random()*s.length),"string"==typeof(l=s[this.modelTexturesId])&&(l=[l]),a.textures=l,[4,this.loadLive2d(r,a)];case 5:return h.sent(),K("我的新衣服好看嘛？",4e3,10),[3,11];case 6:return[4,fetch("".concat(this.apiPath,"rand_textures/?id=").concat(e,"-").concat(i))];case 7:return[4,h.sent().json()];case 8:return 1!==(c=h.sent()).textures.id||1!==i&&0!==i?[3,9]:(K("我还没有其他衣服呢！",4e3,10),[3,11]);case 9:return this.modelTexturesId=c.textures.id,[4,this.loadModel("我的新衣服好看嘛？")];case 10:h.sent(),h.label=11;case 11:return[2]}}))}))},t.prototype.loadNextModel=function(){return it(this,void 0,void 0,(function(){var t,e,i,n;return nt(this,(function(o){switch(o.label){case 0:return t=this.modelId,this.modelTexturesId=0,this.useCDN?this.modelList?[3,2]:(e=this,[4,this.loadModelList()]):[3,4];case 1:e.modelList=o.sent(),o.label=2;case 2:return i=++t>=this.modelList.models.length?0:t,this.modelId=i,[4,this.loadModel(this.modelList.messages[i])];case 3:return o.sent(),[3,8];case 4:return[4,fetch("".concat(this.apiPath,"switch/?id=").concat(t))];case 5:return[4,o.sent().json()];case 6:return n=o.sent(),this.modelId=n.model.id,[4,this.loadModel(n.model.message)];case 7:o.sent(),o.label=8;case 8:return[2]}}))}))},t}(),rt=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))((function(o,r){function s(t){try{l(n.next(t))}catch(t){r(t)}}function a(t){try{l(n.throw(t))}catch(t){r(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(s,a)}l((n=n.apply(t,e||[])).next())}))},st=this&&this.__generator||function(t,e){var i,n,o,r={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return s.next=a(0),s.throw=a(1),s.return=a(2),"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(a){return function(l){return function(a){if(i)throw new TypeError("Generator is already executing.");for(;s&&(s=0,a[0]&&(r=0)),r;)try{if(i=1,n&&(o=2&a[0]?n.return:a[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,a[1])).done)return o;switch(n=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return r.label++,{value:a[1],done:!1};case 5:r.label++,n=a[1],a=[0];continue;case 7:a=r.ops.pop(),r.trys.pop();continue;default:if(!(o=r.trys,(o=o.length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){r=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){r.label=a[1];break}if(6===a[0]&&r.label<o[1]){r.label=o[1],o=a;break}if(o&&r.label<o[2]){r.label=o[2],r.ops.push(a);break}o[2]&&r.ops.pop(),r.trys.pop();continue}a=e.call(t,r)}catch(t){a=[6,t],n=0}finally{i=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,l])}}};function at(t){var e,i,n=!1,o=t.message.default;window.addEventListener("mousemove",(function(){return n=!0})),window.addEventListener("keydown",(function(){return n=!0})),setInterval((function(){n?(n=!1,clearInterval(e),e=null):e||(e=setInterval((function(){K(Z(o),6e3,9)}),2e4))}),1e3),K(function(t){if("/"===location.pathname)for(var e=0,i=t;e<i.length;e++){var n=i[e],o=n.hour,r=n.text,s=new Date,a=o.split("-")[0],l=o.split("-")[1]||a;if(Number(a)<=s.getHours()&&s.getHours()<=Number(l))return r}var c,h="欢迎阅读<span>「".concat(document.title.split(" - ")[0],"」</span>");if(""!==document.referrer){var u=new URL(document.referrer),d=u.hostname.split(".")[1],p={baidu:"百度",so:"360搜索",google:"谷歌搜索"};return location.hostname===u.hostname?h:(c=d in p?p[d]:u.hostname,"Hello！来自 <span>".concat(c,"</span> 的朋友<br>").concat(h))}return h}(t.time),7e3,11),window.addEventListener("mouseover",(function(e){for(var n,o=0,r=t.mouseover;o<r.length;o++){var s=r[o],a=s.selector,l=s.text;if(null===(n=e.target)||void 0===n?void 0:n.closest(a)){if(i===a)return;return i=a,void K(l=(l=Z(l)).replace("{text}",e.target.innerText),4e3,8)}}})),window.addEventListener("click",(function(e){for(var i,n=0,o=t.click;n<o.length;n++){var r=o[n],s=r.selector,a=r.text;if(null===(i=e.target)||void 0===i?void 0:i.closest(s))return void K(a=(a=Z(a)).replace("{text}",e.target.innerText),4e3,8)}})),t.seasons.forEach((function(t){var e=t.date,i=t.text,n=new Date,r=e.split("-")[0],s=e.split("-")[1]||r;Number(r.split("/")[0])<=n.getMonth()+1&&n.getMonth()+1<=Number(s.split("/")[0])&&Number(r.split("/")[1])<=n.getDate()&&n.getDate()<=Number(s.split("/")[1])&&(i=(i=Z(i)).replace("{year}",String(n.getFullYear())),o.push(i))}));var r=function(){};console.log("%c",r),r.toString=function(){K(t.message.console,6e3,9)},window.addEventListener("copy",(function(){K(t.message.copy,6e3,9)})),window.addEventListener("visibilitychange",(function(){document.hidden||K(t.message.visibilitychange,6e3,9)}))}function lt(t){return rt(this,void 0,void 0,(function(){var e;return st(this,(function(i){switch(i.label){case 0:return localStorage.removeItem("waifu-display"),sessionStorage.removeItem("waifu-text"),document.body.insertAdjacentHTML("beforeend",'<div id="waifu">\n       <div id="waifu-tips"></div>\n       <canvas id="live2d" width="800" height="800"></canvas>\n       <div id="waifu-tool"></div>\n     </div>'),[4,(e=new ot(t)).loadModel("")];case 1:return i.sent(),function(t,e){et["switch-model"].callback=function(){return t.loadNextModel()},et["switch-texture"].callback=function(){return t.loadRandTexture()},Array.isArray(e.tools)||(e.tools=Object.keys(et));for(var i=0,n=e.tools;i<n.length;i++){var o=n[i];if(et[o]){var r=et[o],s=r.icon,a=r.callback;document.getElementById("waifu-tool").insertAdjacentHTML("beforeend",'<span id="waifu-tool-'.concat(o,'">').concat(s,"</span>")),document.getElementById("waifu-tool-".concat(o)).addEventListener("click",a)}}}(e,t),t.drag&&function(){var t=document.getElementById("waifu"),e=document.getElementById("live2d");if(t&&e){var i=window.innerWidth,n=window.innerHeight,o=t.offsetWidth,r=t.offsetHeight;t.addEventListener("mousedown",(function(s){if(2!==s.button&&s.target===e){s.preventDefault();var a=s.offsetX,l=s.offsetY;document.onmousemove=function(e){var s=e.clientX,c=e.clientY,h=s-a,u=c-l;u<0?u=0:u>=n-r&&(u=n-r),h<0?h=0:h>=i-o&&(h=i-o),t.style.top=u+"px",t.style.left=h+"px"},document.onmouseup=function(){document.onmousemove=null}}})),window.onresize=function(){i=window.innerWidth,n=window.innerHeight}}}(),t.waifuPath?[4,fetch(t.waifuPath)]:[3,4];case 2:return[4,i.sent().json()];case 3:at(i.sent()),i.label=4;case 4:return document.getElementById("waifu").style.bottom="0",[2]}}))}))}window.initWidget=function(t){if("string"!=typeof t){n.setLevel(t.logLevel),document.body.insertAdjacentHTML("beforeend",'<div id="waifu-toggle">\n       <span>看板娘</span>\n     </div>');var e=document.getElementById("waifu-toggle");null==e||e.addEventListener("click",(function(){e.classList.remove("waifu-toggle-active"),(null==e?void 0:e.getAttribute("first-time"))?(lt(t),null==e||e.removeAttribute("first-time")):(localStorage.removeItem("waifu-display"),document.getElementById("waifu").style.display="",setTimeout((function(){document.getElementById("waifu").style.bottom="0"}),0))})),localStorage.getItem("waifu-display")&&Date.now()-Number(localStorage.getItem("waifu-display"))<=864e5?(null==e||e.setAttribute("first-time","true"),setTimeout((function(){null==e||e.classList.add("waifu-toggle-active")}),0)):lt(t)}else n.error("Your config for Live2d initWidget is outdated. Please refer to https://github.com/stevenjoezhang/live2d-widget/blob/master/dist/autoload.js")}}();
